<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mi Perfil</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>

<div class="header">
  <h1>panaderia desesperanza</h1>
</div>

<nav class="navbar navbar-expand-lg navbar-dark bg-success px-3">
  <div class="container-fluid">

    <a class="navbar-brand" href="index.html">PanaderÃ­a</a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
            data-bs-target="#navbarSupportedContent">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">

      <ul class="navbar-nav me-auto mb-2 mb-lg-0">

        <!-- âœ… Botones para NO logueados - CORREGIDOS -->
        <li class="nav-item" id="nav-login-btn">
          <button class="btn btn-outline-light" data-open="modal-login" type="button">
            ğŸ” Inicio de sesiÃ³n
          </button>
        </li>

        <li class="nav-item" id="nav-registro-btn">
          <button class="btn btn-outline-light ms-2" data-open="modal-registro" type="button">
            ğŸ“ Registrar
          </button>
        </li>

        <!-- âœ… USUARIO LOGUEADO CON SALDO -->
        <li class="nav-item d-none" id="nav-usuario">
          <span class="nav-link">
            ğŸ‘¤ <b id="nav-usuario-nombre"></b> 
            | ğŸ’° <span id="nav-usuario-saldo" class="badge bg-warning text-dark">$0.00</span>
          </span>
        </li>

        <!-- BotÃ³n logout -->
        <li class="nav-item d-none" id="nav-logout">
          <button class="btn btn-danger btn-sm ms-2" id="logoutBtn">
            ğŸšª Cerrar sesiÃ³n
          </button>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="#acerca">Nosotros</a>
        </li>

        <!-- MenÃº dropdown -->
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" 
             data-bs-toggle="dropdown">
            MenÃº
          </a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="perfil.html">Perfil</a></li>
            <li><a class="dropdown-item" href="compra.html">Compra</a></li>
            <li><a class="dropdown-item admin-only d-none" href="inventario.html">
              Inventario
            </a></li>
            <li><a class="dropdown-item admin-only d-none" href="ventas.html">
              Ventas
            </a></li>
          </ul>
        </li>

        <!-- âœ… Carrito -->
        <li class="nav-item d-none" id="nav-carrito-btn">
          <button class="btn btn-warning btn-sm" data-open="modal-carrito">
            ğŸ›’ <span id="carrito-cantidad">0</span>
          </button>
        </li>

        <li class="nav-item">
          <a class="nav-link">ğŸ…</a>
        </li>
        <li class="nav-item">
          <a class="nav-link">ğŸ„</a>
        </li>
        <li class="nav-item">
          <a class="nav-link">â„ï¸</a>
        </li>

      </ul>

    </div>
  </div>
</nav>

<div class="perfil-container">
  <div class="perfil-card">
    <div class="perfil-header">
      <img id="perfil-foto" class="perfil-foto" src="https://via.placeholder.com/120" alt="Foto">
      <h2 id="perfil-nombre">Usuario</h2>
      <p id="perfil-email">email@example.com</p>
    </div>

    <div class="perfil-info">
      <p><b>Rol:</b> <span id="perfil-rol">Cliente</span></p>
      <p><b>ğŸ’° Saldo:</b> <span id="perfil-saldo" class="badge bg-success">$0.00</span></p>
    </div>

    <div class="perfil-actions">
      <button class="btn btn-primary" id="btn-editar">âœï¸ Editar perfil</button>
      <button class="btn btn-info" id="btn-historial">ğŸ“œ Mi Historial</button>
      <button class="btn btn-success" id="btn-recargar">ğŸ’° Recargar Saldo</button>
      <button class="btn btn-warning admin-only d-none" id="btn-admin-usuarios">ğŸ‘¥ Usuarios</button>
    </div>
  </div>
</div>

<!-- Modal Editar -->
<dialog id="modal-editar">
  <button class="btn-x" onclick="document.getElementById('modal-editar').close()">X</button>
  <h2>Editar Perfil</h2>
  <div style="padding:20px;">
    <label>Nombre:</label>
    <input type="text" id="modal-edit-nombre" class="form-control" required>
    <label>Email:</label>
    <input type="email" id="modal-edit-email" class="form-control" required>
    <label>ContraseÃ±a (opcional):</label>
    <input type="password" id="modal-edit-password" class="form-control">
    <label>Foto:</label>
    <input type="file" id="modal-edit-imagen" class="form-control" accept="image/*">
    <button class="btn btn-success mt-3" id="btn-guardar-perfil">Guardar</button>
  </div>
</dialog>

<!-- Modal Historial -->
<dialog id="modal-historial" style="width:90%;max-width:900px;">
  <button class="btn-x" onclick="document.getElementById('modal-historial').close()">X</button>
  <h2>Mi Historial</h2>
  <div id="lista-compras-modal"></div>
  <button class="btn btn-secondary mt-3" onclick="document.getElementById('modal-historial').close()">Cerrar</button>
</dialog>

<!-- Modal Detalle Compra -->
<dialog id="modal-detalle-compra" style="width:90%;max-width:700px;">
  <button class="btn-x" onclick="document.getElementById('modal-detalle-compra').close()">X</button>
  <h2>Detalle de Compra</h2>
  <div id="contenido-detalle-compra"></div>
  <button class="btn btn-secondary mt-3" id="btn-volver-historial">â¬…ï¸ Volver</button>
</dialog>

<!-- Modal Recargar -->
<dialog id="modal-recargar-saldo-simple" style="width:90%;max-width:500px;">
  <button class="btn-x" onclick="document.getElementById('modal-recargar-saldo-simple').close()">X</button>
  <h2>Recargar Saldo</h2>
  <div style="padding:20px;">
    <p>Usuario: <b id="recarga-usuario-nombre"></b></p>
    <p>Saldo: <b id="recarga-usuario-saldo"></b></p>
    <input type="number" id="recarga-monto-input" class="form-control" placeholder="Monto" step="0.01">
    <button class="btn btn-success mt-3" id="btn-confirmar-recarga">Confirmar</button>
  </div>
</dialog>

<!-- Modal Usuarios (Admin) -->
<dialog id="modal-usuarios" style="width:90%;max-width:900px;">
  <button class="btn-x" onclick="document.getElementById('modal-usuarios').close()">X</button>
  <h2>Usuarios</h2>
  <table class="table">
    <thead>
      <tr><th>ID</th><th>Nombre</th><th>Email</th><th>Rol</th><th>Saldo</th><th>Acciones</th></tr>
    </thead>
    <tbody id="tablaUsuarios"></tbody>
  </table>
</dialog>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="script.js"></script>

<script>
// âœ… SCRIPTS LOCALES PARA PERFIL
const API_URL = "https://panaderia-navidad.onrender.com";

document.addEventListener("DOMContentLoaded", async () => {
    console.log("ğŸ”§ Iniciando perfil...");
    
    const user = JSON.parse(localStorage.getItem("usuario"));
    
    if (!user) {
        alert("Inicia sesiÃ³n");
        window.location.href = "index.html";
        return;
    }

    // Cargar datos
    document.getElementById("perfil-nombre").textContent = user.nombre;
    document.getElementById("perfil-email").textContent = user.email;
    document.getElementById("perfil-rol").textContent = user.rol;
    document.getElementById("perfil-saldo").textContent = `$${parseFloat(user.saldo || 0).toFixed(2)}`;

    // BotÃ³n editar
    document.getElementById("btn-editar").onclick = async () => {
        console.log("Click editar");
        document.getElementById("modal-edit-nombre").value = user.nombre;
        document.getElementById("modal-edit-email").value = user.email;
        document.getElementById("modal-editar").showModal();
    };

    // BotÃ³n guardar perfil
    document.getElementById("btn-guardar-perfil").onclick = async () => {
        const nombre = document.getElementById("modal-edit-nombre").value;
        const email = document.getElementById("modal-edit-email").value;
        const password = document.getElementById("modal-edit-password").value;
        
        const formData = new FormData();
        formData.append("id_usuario", user.id_usuario);
        formData.append("nombre", nombre);
        formData.append("email", email);
        if (password) formData.append("password", password);
        
        const imagen = document.getElementById("modal-edit-imagen").files[0];
        if (imagen) formData.append("imagen", imagen);

        try {
            const res = await fetch(`${API_URL}/api/usuario/editar`, {
                method: "PUT",
                body: formData
            });

            const data = await res.json();

            if (data.success) {
                alert("âœ… Perfil actualizado");
                user.nombre = nombre;
                user.email = email;
                localStorage.setItem("usuario", JSON.stringify(user));
                document.getElementById("modal-editar").close();
                location.reload();
            } else {
                alert("âŒ Error: " + data.message);
            }
        } catch (err) {
            console.error(err);
            alert("âŒ Error de conexiÃ³n");
        }
    };

    // BotÃ³n historial
    document.getElementById("btn-historial").onclick = async () => {
        console.log("Click historial");
        document.getElementById("modal-historial").showModal();
        
        try {
            const res = await fetch(`${API_URL}/api/usuario/${user.id_usuario}/compras`);
            const data = await res.json();
            
            const lista = document.getElementById("lista-compras-modal");
            
            if (!data.success || !data.compras || data.compras.length === 0) {
                lista.innerHTML = '<p>No hay compras</p>';
                return;
            }

            lista.innerHTML = data.compras.map(c => `
                <div style="border:1px solid #ddd; padding:10px; margin:10px 0; border-radius:8px; cursor:pointer;"
                     onclick="verDetalleLocal(${c.id_venta})">
                    <b>Compra #${c.id_venta}</b> - ${new Date(c.fecha).toLocaleDateString()} - $${parseFloat(c.total).toFixed(2)}
                </div>
            `).join("");

        } catch (err) {
            console.error(err);
        }
    };

    // FunciÃ³n ver detalle
    window.verDetalleLocal = async (idVenta) => {
        try {
            const res = await fetch(`${API_URL}/api/venta/${idVenta}`);
            const data = await res.json();

            if (!data.success) {
                alert("âŒ Error");
                return;
            }

            const venta = data.venta;
            const productos = data.detalles || [];

            document.getElementById("modal-historial").close();

            const html = `
                <h3>Compra #${venta.id_venta}</h3>
                <p>Fecha: ${new Date(venta.fecha).toLocaleString()}</p>
                ${productos.map(p => `<p>${p.nombre_producto} - Cant: ${p.cantidad} - $${parseFloat(p.subtotal).toFixed(2)}</p>`).join("")}
                <h4>Total: $${parseFloat(venta.monto_pagado).toFixed(2)}</h4>
            `;

            document.getElementById("contenido-detalle-compra").innerHTML = html;
            document.getElementById("modal-detalle-compra").showModal();

        } catch (err) {
            console.error(err);
            alert("âŒ Error");
        }
    };

    // BotÃ³n volver
    document.getElementById("btn-volver-historial").onclick = () => {
        document.getElementById("modal-detalle-compra").close();
        setTimeout(() => document.getElementById("modal-historial").showModal(), 200);
    };

    // BotÃ³n recargar
    document.getElementById("btn-recargar").onclick = () => {
        console.log("Click recargar");
        document.getElementById("recarga-usuario-nombre").textContent = user.nombre;
        document.getElementById("recarga-usuario-saldo").textContent = `$${parseFloat(user.saldo || 0).toFixed(2)}`;
        document.getElementById("modal-recargar-saldo-simple").showModal();
    };

    // Confirmar recarga
    document.getElementById("btn-confirmar-recarga").onclick = async () => {
        const monto = parseFloat(document.getElementById("recarga-monto-input").value);
        
        if (!monto || monto <= 0) {
            alert("âš ï¸ Monto invÃ¡lido");
            return;
        }

        try {
            const res = await fetch(`${API_URL}/api/usuario/recargar`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    id_usuario: user.id_usuario,
                    monto: monto
                })
            });

            const data = await res.json();

            if (data.success) {
                user.saldo = data.nuevoSaldo;
                localStorage.setItem("usuario", JSON.stringify(user));
                alert(`âœ… Recarga exitosa!\n\nNuevo saldo: $${data.nuevoSaldo.toFixed(2)}`);
                document.getElementById("perfil-saldo").textContent = `$${data.nuevoSaldo.toFixed(2)}`;
                document.getElementById("modal-recargar-saldo-simple").close();
            } else {
                alert("âŒ " + data.message);
            }
        } catch (err) {
            console.error(err);
            alert("âŒ Error");
        }
    };

    // BotÃ³n admin usuarios
    if (user.rol === "admin") {
        const btnAdmin = document.getElementById("btn-admin-usuarios");
        btnAdmin.classList.remove("d-none");
        
        btnAdmin.onclick = async () => {
            console.log("Click admin usuarios");
            document.getElementById("modal-usuarios").showModal();
            
            try {
                const res = await fetch(`${API_URL}/api/usuarios`);
                const usuarios = await res.json();
                
                const tbody = document.getElementById("tablaUsuarios");
                
                if (!Array.isArray(usuarios) || usuarios.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6">No hay usuarios</td></tr>';
                    return;
                }

                tbody.innerHTML = usuarios.map(u => `
                    <tr>
                        <td>${u.id_usuario}</td>
                        <td>${u.nombre}</td>
                        <td>${u.email}</td>
                        <td>${u.rol}</td>
                        <td>$${parseFloat(u.saldo || 0).toFixed(2)}</td>
                        <td><button class="btn btn-danger btn-sm" onclick="eliminarUsuarioLocal(${u.id_usuario})">Eliminar</button></td>
                    </tr>
                `).join("");

            } catch (err) {
                console.error(err);
            }
        };
    }

    // FunciÃ³n eliminar usuario
    window.eliminarUsuarioLocal = async (id) => {
        if (!confirm("Â¿Eliminar usuario?")) return;

        try {
            const res = await fetch(`${API_URL}/api/usuario/eliminar/${id}`, {
                method: "DELETE"
            });

            if (res.ok) {
                alert("âœ… Usuario eliminado");
                document.getElementById("btn-admin-usuarios").click();
            } else {
                alert("âŒ Error");
            }
        } catch (err) {
            console.error(err);
        }
    };

    console.log("âœ… Perfil cargado");
});
</script>

</body>
</html>