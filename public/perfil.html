<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mi Perfil</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>

<div class="header">
  <h1>panaderia desesperanza</h1>
</div>

<nav class="navbar navbar-expand-lg navbar-dark bg-success px-3">
  <div class="container-fluid">
    <a class="navbar-brand" href="index.html">PanaderÃ­a</a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
            data-bs-target="#navbarSupportedContent">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item" id="nav-login-btn">
          <button class="btn btn-outline-light" data-open="modal-login" type="button">
            ğŸ” Inicio de sesiÃ³n
          </button>
        </li>

        <li class="nav-item" id="nav-registro-btn">
          <button class="btn btn-outline-light ms-2" data-open="modal-registro" type="button">
            ğŸ“ Registrar
          </button>
        </li>

        <li class="nav-item d-none" id="nav-usuario">
          <span class="nav-link">
            ğŸ‘¤ <b id="nav-usuario-nombre"></b> 
            | ğŸ’° <span id="nav-usuario-saldo" class="badge bg-warning text-dark">$0.00</span>
          </span>
        </li>

        <li class="nav-item d-none" id="nav-logout">
          <button class="btn btn-danger btn-sm ms-2" id="logoutBtn">
            ğŸšª Cerrar sesiÃ³n
          </button>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="#acerca">Nosotros</a>
        </li>

        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" 
             data-bs-toggle="dropdown">
            MenÃº
          </a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="perfil.html">Perfil</a></li>
            <li><a class="dropdown-item" href="compra.html">Compra</a></li>
            <li><a class="dropdown-item admin-only d-none" href="inventario.html">Inventario</a></li>
            <li><a class="dropdown-item admin-only d-none" href="ventas.html">Ventas</a></li>
          </ul>
        </li>

        <li class="nav-item d-none" id="nav-carrito-btn">
          <button class="btn btn-warning btn-sm" data-open="modal-carrito">
            ğŸ›’ <span id="carrito-cantidad">0</span>
          </button>
        </li>

        <li class="nav-item"><a class="nav-link">ğŸ…</a></li>
        <li class="nav-item"><a class="nav-link">ğŸ„</a></li>
        <li class="nav-item"><a class="nav-link">â„ï¸</a></li>
      </ul>
    </div>
  </div>
</nav>

<!-- âœ… SECCIÃ“N DE PERFIL -->
<div class="perfil-container">
  <div class="perfil-card">
    <div class="perfil-header">
      <img id="perfil-foto" class="perfil-foto" src="https://via.placeholder.com/120" alt="Foto">
      <h2 id="perfil-nombre">Usuario</h2>
      <p id="perfil-email">email@example.com</p>
    </div>

    <div class="perfil-info">
      <p><b>Rol:</b> <span id="perfil-rol">Cliente</span></p>
      <p><b>ğŸ’° Saldo:</b> <span id="perfil-saldo" class="badge bg-success">$0.00</span></p>
    </div>

    <div class="perfil-actions">
      <button class="btn btn-primary" id="btn-editar-perfil">âœï¸ Editar perfil</button>
      <button class="btn btn-info" id="btn-historial-perfil">ğŸ“œ Mi Historial</button>
      <button class="btn btn-success" id="btn-recargar-perfil">ğŸ’° Recargar Saldo</button>
      <button class="btn btn-warning admin-only d-none" id="btn-admin-usuarios-perfil">ğŸ‘¥ Usuarios</button>
    </div>
  </div>
</div>

<!-- âœ… MODAL EDITAR PERFIL -->
<dialog id="modal-editar-perfil">
  <button class="btn-x" onclick="cerrarModalPerfil('modal-editar-perfil')">X</button>
  <h2>Editar Perfil</h2>
  <div style="padding:20px;">
    <label>Nombre:</label>
    <input type="text" id="modal-edit-nombre-perfil" class="form-control" required>
    
    <label>Email:</label>
    <input type="email" id="modal-edit-email-perfil" class="form-control" required>
    
    <label>ContraseÃ±a (opcional):</label>
    <input type="password" id="modal-edit-password-perfil" class="form-control">
    
    <label>Foto:</label>
    <input type="file" id="modal-edit-imagen-perfil" class="form-control" accept="image/*">
    
    <button class="btn btn-success mt-3" id="btn-guardar-perfil-cambios">Guardar</button>
  </div>
</dialog>

<!-- âœ… MODAL HISTORIAL -->
<dialog id="modal-historial-perfil" style="width:90%;max-width:900px;">
  <button class="btn-x" onclick="cerrarModalPerfil('modal-historial-perfil')">X</button>
  <h2>Mi Historial</h2>
  <div id="lista-compras-modal-perfil"></div>
  <button class="btn btn-secondary mt-3" onclick="cerrarModalPerfil('modal-historial-perfil')">Cerrar</button>
</dialog>

<!-- âœ… MODAL DETALLE COMPRA -->
<dialog id="modal-detalle-compra-perfil" style="width:90%;max-width:700px;">
  <button class="btn-x" onclick="cerrarModalPerfil('modal-detalle-compra-perfil')">X</button>
  <h2>Detalle de Compra</h2>
  <div id="contenido-detalle-compra-perfil"></div>
  <button class="btn btn-secondary mt-3" id="btn-volver-historial-perfil">â¬…ï¸ Volver</button>
</dialog>

<!-- âœ… MODAL RECARGAR SALDO -->
<dialog id="modal-recargar-saldo-perfil" style="width:90%;max-width:500px;">
  <button class="btn-x" onclick="cerrarModalPerfil('modal-recargar-saldo-perfil')">X</button>
  <h2>Recargar Saldo</h2>
  <div style="padding:20px;">
    <p>Usuario: <b id="recarga-usuario-nombre-perfil"></b></p>
    <p>Saldo actual: <b id="recarga-usuario-saldo-perfil"></b></p>
    <input type="number" id="recarga-monto-input-perfil" class="form-control" placeholder="Monto" step="0.01" min="0.01">
    <button class="btn btn-success mt-3" id="btn-confirmar-recarga-perfil">Confirmar</button>
  </div>
</dialog>

<!-- âœ… MODAL USUARIOS (ADMIN) -->
<dialog id="modal-usuarios-perfil" style="width:90%;max-width:900px;">
  <button class="btn-x" onclick="cerrarModalPerfil('modal-usuarios-perfil')">X</button>
  <h2>GestiÃ³n de Usuarios</h2>
  <table class="table table-striped">
    <thead>
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Email</th>
        <th>Rol</th>
        <th>Saldo</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="tablaUsuariosPerfil"></tbody>
  </table>
</dialog>

    <div class="container">
	<div class="snowflakes" aria-hidden="true">
		<div class="snowflake">
			â…
		</div>
		<div class="snowflake">
			â†
		</div>
		<div class="snowflake">
			â…
		</div>
		<div class="snowflake">
			â†
		</div>
		<div class="snowflake">
			â…
		</div>
		<div class="snowflake">
			â†
		</div>
		<div class="snowflake">
			â…
		</div>
		<div class="snowflake">
			â†
		</div>
		<div class="snowflake">
			â…
		</div>
		<div class="snowflake">
			â†
		</div>
		<div class="snowflake">
			â…
		</div>
		<div class="snowflake">
			â†
		</div>
	</div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="script.js"></script>

<script>
// âœ… FUNCIONES LOCALES PARA PERFIL
const API_URL = "https://panaderia-navidad.onrender.com";

function cerrarModalPerfil(id) {
    const modal = document.getElementById(id);
    if (modal) modal.close();
}

document.addEventListener("DOMContentLoaded", async () => {
    console.log("ğŸ”§ Iniciando perfil...");
    
    const user = JSON.parse(localStorage.getItem("usuario"));
    
    if (!user) {
        alert("âš ï¸ Debes iniciar sesiÃ³n para ver tu perfil");
        window.location.href = "index.html";
        return;
    }

    // Cargar datos bÃ¡sicos
    document.getElementById("perfil-nombre").textContent = user.nombre;
    document.getElementById("perfil-email").textContent = user.email;
    document.getElementById("perfil-rol").textContent = user.rol;
    document.getElementById("perfil-saldo").textContent = `$${parseFloat(user.saldo || 0).toFixed(2)}`;

    // âœ… BOTÃ“N EDITAR PERFIL
    document.getElementById("btn-editar-perfil").onclick = async () => {
        console.log("âœ… Click editar perfil");
        
        document.getElementById("modal-edit-nombre-perfil").value = user.nombre;
        document.getElementById("modal-edit-email-perfil").value = user.email;
        
        const modal = document.getElementById("modal-editar-perfil");
        if (modal) {
            modal.showModal();
            console.log("âœ… Modal editar abierto");
        } else {
            console.error("âŒ Modal no encontrado");
        }
    };

    // âœ… GUARDAR CAMBIOS DE PERFIL
    document.getElementById("btn-guardar-perfil-cambios").onclick = async () => {
        const nombre = document.getElementById("modal-edit-nombre-perfil").value.trim();
        const email = document.getElementById("modal-edit-email-perfil").value.trim();
        const password = document.getElementById("modal-edit-password-perfil").value.trim();
        
        if (!nombre || !email) {
            alert("âš ï¸ Nombre y email son obligatorios");
            return;
        }

        const formData = new FormData();
        formData.append("id_usuario", user.id_usuario);
        formData.append("nombre", nombre);
        formData.append("email", email);
        if (password) formData.append("password", password);
        
        const imagen = document.getElementById("modal-edit-imagen-perfil").files[0];
        if (imagen) formData.append("imagen", imagen);

        try {
            const res = await fetch(`${API_URL}/api/usuario/editar`, {
                method: "PUT",
                body: formData
            });

            const data = await res.json();

            if (data.success) {
                alert("âœ… Perfil actualizado exitosamente");
                user.nombre = nombre;
                user.email = email;
                localStorage.setItem("usuario", JSON.stringify(user));
                cerrarModalPerfil('modal-editar-perfil');
                location.reload();
            } else {
                alert("âŒ Error: " + (data.message || "No se pudo actualizar"));
            }
        } catch (err) {
            console.error(err);
            alert("âŒ Error de conexiÃ³n");
        }
    };

    // âœ… BOTÃ“N HISTORIAL
    document.getElementById("btn-historial-perfil").onclick = async () => {
        console.log("âœ… Click historial");
        
        const modal = document.getElementById("modal-historial-perfil");
        if (modal) {
            modal.showModal();
            
            try {
                const res = await fetch(`${API_URL}/api/usuario/${user.id_usuario}/compras`);
                const data = await res.json();
                
                const lista = document.getElementById("lista-compras-modal-perfil");
                
                if (!data.success || !data.compras || data.compras.length === 0) {
                    lista.innerHTML = '<p class="text-center">No tienes compras registradas</p>';
                    return;
                }

                lista.innerHTML = data.compras.map(c => `
                    <div style="border:1px solid #ddd; padding:15px; margin:10px 0; border-radius:8px; cursor:pointer; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;"
                         onclick="verDetalleCompraPerfil(${c.id_venta})">
                        <b>ğŸ›’ Compra #${c.id_venta}</b><br>
                        ğŸ“… ${new Date(c.fecha).toLocaleDateString('es-MX')}<br>
                        ğŸ’° Total: $${parseFloat(c.total).toFixed(2)}
                    </div>
                `).join("");

            } catch (err) {
                console.error(err);
                alert("âŒ Error al cargar historial");
            }
        }
    };

    // âœ… FUNCIÃ“N VER DETALLE
    window.verDetalleCompraPerfil = async (idVenta) => {
        try {
            const res = await fetch(`${API_URL}/api/venta/${idVenta}`);
            const data = await res.json();

            if (!data.success) {
                alert("âŒ Error al cargar detalle");
                return;
            }

            cerrarModalPerfil('modal-historial-perfil');

            const venta = data.venta;
            const productos = data.detalles || [];

            const html = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; color: white; margin-bottom: 20px;">
                    <h3>ğŸ›’ Compra #${venta.id_venta}</h3>
                    <p>ğŸ“… ${new Date(venta.fecha).toLocaleString('es-MX')}</p>
                </div>
                ${productos.map(p => `
                    <div style="background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #667eea;">
                        <b>${p.nombre_producto}</b><br>
                        Cantidad: ${p.cantidad} | Precio: $${parseFloat(p.precio).toFixed(2)}<br>
                        <b>Subtotal: $${parseFloat(p.subtotal).toFixed(2)}</b>
                    </div>
                `).join("")}
                <div style="background: #ffd700; padding: 20px; border-radius: 10px; text-align: center; margin-top: 20px;">
                    <h4 style="margin: 0; color: #333;">ğŸ’° TOTAL: $${parseFloat(venta.monto_pagado).toFixed(2)}</h4>
                </div>
            `;

            document.getElementById("contenido-detalle-compra-perfil").innerHTML = html;
            document.getElementById("modal-detalle-compra-perfil").showModal();

        } catch (err) {
            console.error(err);
            alert("âŒ Error al cargar detalle");
        }
    };

    // âœ… BOTÃ“N VOLVER
    document.getElementById("btn-volver-historial-perfil").onclick = () => {
        cerrarModalPerfil('modal-detalle-compra-perfil');
        setTimeout(() => document.getElementById("modal-historial-perfil").showModal(), 200);
    };

    // âœ… BOTÃ“N RECARGAR SALDO
    document.getElementById("btn-recargar-perfil").onclick = () => {
        console.log("âœ… Click recargar saldo");
        
        document.getElementById("recarga-usuario-nombre-perfil").textContent = user.nombre;
        document.getElementById("recarga-usuario-saldo-perfil").textContent = `$${parseFloat(user.saldo || 0).toFixed(2)}`;
        document.getElementById("recarga-monto-input-perfil").value = "";
        
        const modal = document.getElementById("modal-recargar-saldo-perfil");
        if (modal) {
            modal.showModal();
        }
    };

    // âœ… CONFIRMAR RECARGA
    document.getElementById("btn-confirmar-recarga-perfil").onclick = async () => {
        const monto = parseFloat(document.getElementById("recarga-monto-input-perfil").value);
        
        if (!monto || monto <= 0) {
            alert("âš ï¸ Ingresa un monto vÃ¡lido mayor a $0");
            return;
        }

        if (monto > 100000) {
            alert("âš ï¸ El monto mÃ¡ximo es $100,000");
            return;
        }

        try {
            const res = await fetch(`${API_URL}/api/usuario/recargar`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    id_usuario: user.id_usuario,
                    monto: monto
                })
            });

            const data = await res.json();

            if (data.success) {
                user.saldo = data.nuevoSaldo;
                localStorage.setItem("usuario", JSON.stringify(user));
                
                alert(`âœ… Recarga exitosa!\n\nNuevo saldo: $${data.nuevoSaldo.toFixed(2)}`);
                
                document.getElementById("perfil-saldo").textContent = `$${data.nuevoSaldo.toFixed(2)}`;
                
                const navSaldo = document.getElementById("nav-usuario-saldo");
                if (navSaldo) navSaldo.textContent = `$${data.nuevoSaldo.toFixed(2)}`;
                
                cerrarModalPerfil('modal-recargar-saldo-perfil');
            } else {
                alert("âŒ " + (data.message || "Error al recargar"));
            }
        } catch (err) {
            console.error(err);
            alert("âŒ Error de conexiÃ³n");
        }
    };

    // âœ… BOTÃ“N ADMIN USUARIOS
    if (user.rol === "admin") {
        const btnAdmin = document.getElementById("btn-admin-usuarios-perfil");
        if (btnAdmin) {
            btnAdmin.classList.remove("d-none");
            
            btnAdmin.onclick = async () => {
                console.log("âœ… Click admin usuarios");
                
                const modal = document.getElementById("modal-usuarios-perfil");
                if (modal) {
                    modal.showModal();
                    
                    try {
                        const res = await fetch(`${API_URL}/api/usuarios`);
                        
                        if (!res.ok) {
                            throw new Error(`Error HTTP: ${res.status}`);
                        }
                        
                        const usuarios = await res.json();
                        console.log("ğŸ“Š Usuarios recibidos:", usuarios);
                        
                        const tbody = document.getElementById("tablaUsuariosPerfil");
                        
                        if (!Array.isArray(usuarios) || usuarios.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="6" class="text-center">No hay usuarios registrados</td></tr>';
                            return;
                        }

                        tbody.innerHTML = usuarios.map(u => `
                            <tr>
                                <td>${u.id_usuario}</td>
                                <td>${u.nombre}</td>
                                <td>${u.email}</td>
                                <td><span class="badge bg-${u.rol === 'admin' ? 'danger' : 'primary'}">${u.rol}</span></td>
                                <td>$${parseFloat(u.saldo || 0).toFixed(2)}</td>
                                <td>
                                    <button class="btn btn-danger btn-sm" onclick="eliminarUsuarioPerfil(${u.id_usuario}, '${u.nombre}')">
                                        ğŸ—‘ï¸ Eliminar
                                    </button>
                                </td>
                            </tr>
                        `).join("");

                    } catch (err) {
                        console.error("âŒ Error cargando usuarios:", err);
                        alert("âŒ Error al cargar usuarios: " + err.message);
                    }
                }
            };
        }
    }

    // âœ… FUNCIÃ“N ELIMINAR USUARIO
    window.eliminarUsuarioPerfil = async (id, nombre) => {
        if (id === user.id_usuario) {
            alert("âŒ No puedes eliminar tu propia cuenta");
            return;
        }

        if (!confirm(`âš ï¸ Â¿Eliminar a ${nombre}?\n\nEsta acciÃ³n no se puede deshacer.`)) {
            return;
        }

        try {
            const res = await fetch(`${API_URL}/api/usuario/eliminar/${id}`, {
                method: "DELETE"
            });

            if (res.ok) {
                alert("âœ… Usuario eliminado exitosamente");
                document.getElementById("btn-admin-usuarios-perfil").click();
            } else {
                alert("âŒ Error al eliminar usuario");
            }
        } catch (err) {
            console.error(err);
            alert("âŒ Error de conexiÃ³n");
        }
    };

    console.log("âœ… Perfil cargado completamente");
});
</script>

</body>
</html>